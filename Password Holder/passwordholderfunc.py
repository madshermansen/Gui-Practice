"""
Name: Password Manager
Made By: Mads Hermansen
Github: https://github.com/KarlofKuwait
Date: 05/05/2019
"""
from tkinter import filedialog
import os
import errno
import PySimpleGUI as sg
import string

# Make sure the files are there
filename = ["Userdata/Shortcuts.txt", "Userdata/Usernames.txt", "Userdata/Passwords.txt"]
for Info in filename:
    if not os.path.exists(os.path.dirname(Info)):
        try:
            os.makedirs(os.path.dirname(Info))
        except OSError as exc:
            if exc.errno != errno.EEXIST:
                raise
    try:
        [x.strip() for x in open(Info).readlines()]
    except:
        with open(Info, "w") as f:
            f.write("")

def reset():
    Areyousurelayout = [
        [sg.Text("Are you sure you want to reset all the data?",
                 background_color="white")],
        [sg.Button("Yes"),
         sg.Button("No")],
    ]
    Areyousure = sg.Window("Confirmation",
                      background_color="white",
                      button_color=None,
                      no_titlebar=False,
                      icon="Image/Logo.ico",
                      grab_anywhere=True).Layout(Areyousurelayout)
    event, values = Areyousure.Read()
    if event == "Yes":
        try:
            filename = ["Userdata/Shortcuts.txt", "Userdata/Usernames.txt", "Userdata/Passwords.txt"]
            for Info in filename:
                with open(Info, "w") as f:
                    f.write("")
        except:
            pass
    else:
        pass
    Areyousure.Close()

# Add function and corresponding code
def add(Shortcut, Usernames, Password):
    if Shortcut == "" or Usernames == "" or Password == "":
        setentervaluepage("Please enter values")
        return
    Shortcutwrite(Shortcut)
    Usernameswrite(Usernames)
    Passwordwrite(Password)

def Shortcutwrite(Shortcut):
    try:
        Keepdata = [x.strip() for x in open("Userdata/Shortcuts.txt").readlines()]
        typeShort = open("Userdata/Shortcuts.txt", "w")
    except NameError:
        typeShort = open("Userdata/Shortcuts.txt", "w")
        Keepdata = [x.strip() for x in open("Userdata/Shortcuts.txt").readlines()]
    for Info in Keepdata:
        typeShort.write(str(Info) + "\n")
    typeShort.write(Shortcut + "\n")
    typeShort.close()

def Usernameswrite(Usernames):
    try:
        Keepdata = [x.strip() for x in open("Userdata/Usernames.txt").readlines()]
        typeUser = open("Userdata/Usernames.txt", "w")
    except NameError:
        typeUser = open("Userdata/Usernames.txt", "w")
        Keepdata = [x.strip() for x in open("Userdata/Usernames.txt").readlines()]
    for Info in Keepdata:
        typeUser.write(str(Info) + "\n")
    typeUser.write(Usernames + "\n")
    typeUser.close()

def Passwordwrite(Password):
    try:
        Keepdata = [x.strip() for x in open("Userdata/Passwords.txt").readlines()]
        typePass = open("Userdata/Passwords.txt", "w")
    except NameError:
        typePass = open("Userdata/Passwords.txt", "w")
        Keepdata = [x.strip() for x in open("Userdata/Passwords.txt").readlines()]
    for Info in Keepdata:
        typePass.write(str(Info) + "\n")
    typePass.write(Password + "\n")
    typePass.close()

# Remove function and corresponding code

def remover(Shortcut, Usernames, Password, Testfor):
    global Keepdata
    global Keepdata2
    global Keepdata3
    global RemoveIndex
    RemoveIndex = []
    Keepdata = [x.strip() for x in open("Userdata/Shortcuts.txt").readlines()]
    Keepdata2 = [x.strip() for x in open("Userdata/Usernames.txt").readlines()]
    Keepdata3 = [x.strip() for x in open("Userdata/Passwords.txt").readlines()]
    if Testfor != []:
        Testfor = Testfor[0].split(": ")
        Shortcut = Testfor[0]
        Username = Testfor[1]
        Password = Testfor[2]
        Removerselect(Shortcut, Username, Password)
        return
    elif Shortcut == "" and Usernames == "" and Password == "":
        setentervaluepage("Please enter values")
        return
    else:
        if Shortcut != "":
            RemoverText(Shortcut, Keepdata)
            return
        if Usernames != "":
            RemoverText(Usernames, Keepdata2)
            return
        if Password == "":
            RemoverText(Password, Keepdata3)
            return

def Removerselect(Shortcut, Username, Password):
    for I in range(len(Keepdata)):
        if Shortcut == Keepdata[I] and Username == Keepdata2[I] and Password == Keepdata3[I]:
            RemoveIndex.append(I)
    RemoveIndex.reverse()
    Remover(RemoveIndex)

def RemoverText(Value, Data):
    for Info in range(len(Data)):
        if Value == Data[Info]:
            RemoveIndex.append(Info)
    RemoveIndex.reverse()
    Remover(RemoveIndex)

def Remover(RemoveIndex):
    for Info in RemoveIndex:
        Keepdata.pop(Info)
        Keepdata2.pop(Info)
        Keepdata3.pop(Info)
    typeShort = open("Userdata/Shortcuts.txt", "w")
    for Info in Keepdata:
        typeShort.write(str(Info) + "\n")
    typeShort.close()
    typeUser = open("Userdata/Usernames.txt", "w")
    for Info in Keepdata2:
        typeUser.write(str(Info) + "\n")
    typeUser.close()
    typePass = open("Userdata/Passwords.txt", "w")
    for Info in Keepdata3:
        typePass.write(str(Info) + "\n")
    typePass.close()
    setentervaluepage("Removed " + str(len(RemoveIndex)) + " line(s)")

# Find function and correspondding code

def find(Shortcut, Username, Password):
    global namelist
    namelist = []
    namelist.append(Shortcut)
    namelist.append(Username)
    namelist.append(Password)
    return Finder()



def Finder():
    global Keepdata
    global Keepdata2
    global Keepdata3
    Keepdata = [x.strip() for x in open("Userdata/Shortcuts.txt").readlines()]
    Keepdata2 = [x.strip() for x in open("Userdata/Usernames.txt").readlines()]
    Keepdata3 = [x.strip() for x in open("Userdata/Passwords.txt").readlines()]
    Randomlist = []
    for Info in range(len(Keepdata)):
        namelistcheck = []
        namelistcheck.append(Keepdata[Info] + ": " + Keepdata2[Info] + ": " + Keepdata3[Info])
        for Info2 in range(len(namelistcheck)):
            namelistcheck = namelistcheck[0].split(": ")
        if namelistcheck == namelist:
            Randomlist.append(namelist[0] + ": " + namelist[1] + ": " + namelist[2])
    if Randomlist == []:
        Randomlist = FinderZero(Randomlist)
    return Randomlist

def FinderZero(Randomlist):
    if Randomlist == []:
        for Info in range(len(Keepdata)):
            namelistcheck = []
            namelistcheck.append(Keepdata[Info])
            if namelistcheck[0] == namelist[0]:
                Randomlist.append(Keepdata[Info] + ": " + Keepdata2[Info] + ": " + Keepdata3[Info])
    if Randomlist == []:
        for Info in range(len(Keepdata2)):
            namelistcheck = []
            namelistcheck.append(Keepdata2[Info])
            if namelistcheck[0] == namelist[1]:
                Randomlist.append(Keepdata[Info] + ": " + Keepdata2[Info] + ": " + Keepdata3[Info])
    if Randomlist == []:
        for Info in range(len(Keepdata3)):
            namelistcheck = []
            namelistcheck.append(Keepdata3[Info])
            if namelistcheck[0] == namelist[2]:
                Randomlist.append(Keepdata[Info] + ": " + Keepdata2[Info] + ": " + Keepdata3[Info])
    return Randomlist


# Read function and corresponding code

def read(Shortcut):
    Shortcut = Shortcut[0].split(": ")
    return Shortcut[0], Shortcut[1], Shortcut[2]

# Set namelist


def Setnamelist():
    global namelist
    try:
        names = [x.strip() for x in open("Userdata/Shortcuts.txt").readlines()]
        names2 = [x.strip() for x in open("Userdata/Usernames.txt").readlines()]
        names3 = [x.strip() for x in open("Userdata/Passwords.txt").readlines()]
        namelist = []
        for Info in range(len(names)):
            namelist.append(names[Info] + ": " + names2[Info] + ": " + names3[Info])
    except:
        namelist = []
    return namelist


def SetHolder(Shortcutread, Usernameread, Passwordread, Positionx, namelist):
    Holderlayout = [
        [sg.ButtonMenu("Menu",
                       ["&Menu", ["&About", "&Password Generator", "&Save as", "E&xit"]],
                       button_color=("white", "#111111")),
         sg.Stretch(),
         sg.ButtonMenu("List",
                       ["&List", ["&Reset", "&Reload"]],
                       button_color=("white", "#111111")),
         sg.Stretch()
         ],
        [sg.InputText(Shortcutread,
                      size=(37, 1),
                      background_color="#292929",
                      text_color="white")],
        [sg.InputText(Usernameread,
                      size=(37, 1),
                      background_color="#292929",
                      text_color="white")],
        [sg.InputText(Passwordread,
                      size=(37, 1),
                      background_color="#292929",
                      text_color="white")],
        [sg.Listbox(values=namelist,
                    size=(35, 10),
                    background_color="#292929",
                    text_color="white")],
        [sg.Submit("Add", size=(15, 1),
                   button_color=("white", "#191919")),
         sg.Submit("Remove", size=(15, 1),
                   button_color=("white", "#191919"))],
        [sg.Submit("Find", size=(15, 1),
                   button_color=("white", "#191919")),
         sg.Submit("Open/Read", size=(15, 1),
                   button_color=("white", "#191919"))]
    ]
    global Holder
    try:
        Holder = sg.Window("Password Holder",
                           background_color="#191919",
                           button_color=None,
                           no_titlebar=False,
                           grab_anywhere=False,
                           icon="Image/Logo.ico",
                           location=(Positionx[0],
                                     Positionx[1])).Layout(Holderlayout)
    except:
        Holder = sg.Window("Password Holder",
                           background_color="#191919",
                           button_color=None,
                           no_titlebar=False,
                           icon="Image/Logo.ico",
                           grab_anywhere=False,).Layout(Holderlayout)
    return Holder

def SetAbout():
    aboutlayout = [
        [sg.Text("Name: Password Manager",
                 background_color="white")],
        [sg.Text("Made By: Mads Hermansen",
                 background_color="white")],
        [sg.Text("Github: https://github.com/KarlofKuwait",
                 background_color="white",)]
    ]
    about = sg.Window("About",
                      background_color="white",
                      button_color=None,
                      no_titlebar=False,
                      icon="Image/Logo.ico",
                      grab_anywhere=True).Layout(aboutlayout)
    return about

def setentervaluepage(Message):
    Messagelayout = [
        [sg.Text(Message,
                 background_color="white")]
    ]
    messages = sg.Window("Message",
                      background_color="white",
                      button_color=None,
                      no_titlebar=False,
                      icon = "Image/Logo.ico",
                      grab_anywhere=True).Layout(Messagelayout)
    messages.Read()

def Saveas(NAMELIST):
    try:
        filename = filedialog.asksaveasfilename()
        if not os.path.exists(os.path.dirname(filename)):
            try:
                os.makedirs(os.path.dirname(filename))
            except OSError as exc:
                if exc.errno != errno.EEXIST:
                    raise
        typeSave = open(filename, "w")
        for Info in NAMELIST:
            typeSave.write(str(Info) + "\n")
        typeSave.close()
    except:
        pass

def Genpass(GENLIST, LENGTH):
    PASSWORD = ""
    if GENLIST == []:
        return PASSWORD
    try:
        for i in range(int(LENGTH)):
            random = list(os.urandom(1))
            while not(random[0] <= len(GENLIST)):
                random = list(os.urandom(1))
            PASSWORD += GENLIST[random[0]-1]
        return PASSWORD
    except:
        pass

def Makegenlist(lowercase=False,
                uppercase=False,
                digits=False,
                symbols=False,
                exclude=False,
                exclude2=False):
    GENLIST = []
    if lowercase == True:
        GENLIST += list(string.ascii_lowercase)
    if uppercase == True:
        GENLIST += list(string.ascii_uppercase)
    if digits == True:
        GENLIST += list(string.digits)
    if symbols == True:
        GENLIST += list(string.punctuation)
    if exclude == True:
      excludelist = ["i", "l", "1", "L", "o", "0", "O"]
      for i in excludelist:
          if i in GENLIST:
              GENLIST.remove(i)
    if exclude2 == True:
      excludelist2 = ["|", '{', '}', '[', ']', '(', ')', '/', "'", '`', '~', ',', ';', ':', '.', '<', '>', '"']
      for i in excludelist2:
          if i in GENLIST:
              GENLIST.remove(i)
    return GENLIST

def MakePassGenGUI():
    filename = ["Userdata/Settings.txt"]
    for Info in filename:
        if not os.path.exists(os.path.dirname(Info)):
            try:
                os.makedirs(os.path.dirname(Info))
            except OSError as exc:
                if exc.errno != errno.EEXIST:
                    raise
        try:
            Default = [x.strip() for x in open(Info).readlines()]
            Default[0] = int(Default[0])
            for i in range(1, 8):
                Default[i] = eval(Default[i])
        except:
            with open(Info, "w") as f:
                f.write("")
                Default = [8, True, True, True, True, False, False, False]
    LengthBox = [x for x in range(1, 257)]
    passgenlayout = [
        [sg.Text("Password Length: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.InputCombo(LengthBox,
                 default_value=Default[0],
                 background_color="#191919",
                 text_color="white",
                 key="Length",
                 size=(12, 1),)],
        [sg.Text("Include Symbols: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( e.g. @#$% )",
                     default=Default[1],
                     key="Symbols",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Include Numbers: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( e.g. 123456 )",
                     default=Default[2],
                     key="Digits",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Include Lowercase characters: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( e.g. abcdefgh )",
                     default=Default[3],
                     key="Lowercase",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Include Uppercase characters: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( e.g. ABCDEFGH )",
                     default=Default[4],
                     key="Uppercase",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Exclude similar characters: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( e.g. i, l, 1, L, o, 0, O )",
                     default=Default[5],
                     key="Similar",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Exclude Ambiguous Characters: ",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("( { } [ ] ( ) / \ ' \" ` ~ , ; : . < > )",
                     default=Default[6],
                     key="Similar2",
                     background_color="#191919",
                     text_color="white")],
        [sg.Text("Save preference:",
                 size=(23, 1),
                 background_color="#191919",
                 text_color="white"),
         sg.Checkbox("(saves settings for later use)",
                     default=Default[7],
                     key="Settings",
                     background_color="#191919",
                     text_color="white")],
        [sg.InputText("", key="_text_",
                      text_color="LightGreen",
                      background_color="#292929")],
        [sg.Exit("Exit",
                   button_color=("white", "#191919")),
         sg.Submit("Generate",
                   button_color=("white", "#191919"))]
    ]
    Passgen = sg.Window("Password Generator",
                           background_color="#191919",
                           button_color=None,
                           no_titlebar=False,
                           icon="Image/Logo.ico",
                           grab_anywhere=False,).Layout(passgenlayout)
    while True:
        event2, values2 = Passgen.Read()
        if event2 == None or event2 == "Exit":
            break
        Length = values2["Length"]
        symbols = values2["Symbols"]
        digits = values2["Digits"]
        uppercase = values2["Uppercase"]
        lowercase = values2["Lowercase"]
        exclude = values2["Similar"]
        exclude2 = values2["Similar2"]
        Settings = []
        if values2["Settings"] == True:
            for i in values2:
                Settings.append(values2[i])
            typeSettings = open(filename[0], "w")
            for i in range(0, 8):
                typeSettings.write(str(Settings[i]) + "\n")
            typeSettings.close()

        Password = Genpass((Makegenlist(lowercase, uppercase, digits, symbols, exclude, exclude2)), Length)
        Passgen.FindElement("_text_").Update(Password)
